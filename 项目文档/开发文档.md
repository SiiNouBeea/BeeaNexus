# BeeaNexus - 开发文档

## 4.1 编码规范

### 语言规范：Python 编码风格指南
项目遵循 Python 的 PEP 8 编程规范，主要包括以下几点：
- **缩进**：使用 4 个空格进行缩进。
- **行长度**：每行不超过 79 个字符。
- **命名规则**：
  - **变量名**和**函数名**使用小写字母，多个单词之间用下划线分隔（e.g., `user_id`, `get_messages`）。
  - **类名**使用大写字母开头的驼峰式命名（e.g., `DesktopClient`, `DatabaseManager`）。
  - **常量**使用全大写字母，多个单词之间用下划线分隔（e.g., `DB_CONFIG`, `RCON_CONFIG`）。
- **注释**：使用 UTF-8 编码，注释语言为中文或英文，要求清晰简洁。
- **编码声明**：所有文件以 UTF-8 编码保存，并在文件头部声明编码格式（如 `# -*- coding: utf-8 -*-`）。

### 命名规则：变量、函数和类的命名约定
- **变量名**应简洁且语义明确，避免使用单字母变量名（特殊情况除外，如循环计数器 `i`、`j`）。
- **函数名**应准确描述函数功能，使用动词短语开头（如 `register_user`, `send_message`）。
- **类名**应反映其功能或职责，使用名词短语（如 `MainWindow`, `MessagePage`）。
- **模块名**应简短且具有描述性，使用小写字母和下划线（如 `client.py`, `tools.py`）。

## 4.2 代码结构

### 项目组织：目录结构说明
项目的目录结构如下：
```
客户端根目录/
└── client.py             # 客户端应用入口

服务端根目录/
├── tools.py              # 工具类和数据库管理模块
├── server.py             # 服务端应用入口
├── contacts/             # 联系人列表数据
├── gift_records/         # 礼物记录数据
├── 白名单相关/             # 白名单记录
├── 签到日志/               #签到记录
└── Database/             # 数据库相关文件夹
    └── 建表文件.sql        # 数据库初始化脚本
```

### 核心模块说明
1. **client.py**
   - **功能**：实现客户端的图形化界面和网络通信逻辑。
   - **主要类**：
     - `DesktopClient`：负责与服务端的 TCP 通信，管理消息的发送与接收。
     - `MainWindow`：主窗口类，包含导航栏和多页面布局，管理用户会话和界面状态。
     - `MessagePage`：聊天界面，处理消息显示、发送和联系人管理。

2. **tools.py**
   - **功能**：提供数据库操作、工具函数和业务逻辑支持。
   - **主要类**：
     - `DatabaseManager`：封装了对 MySQL 数据库的所有操作，包括用户管理、消息存储、白名单管理等。
   - **工具函数**：
     - `_hash_pwd` 和 `_check_pwd`：用于密码的加密和验证。
     - `_rcon`：用于发送 RCON 命令，管理我的世界服务器的白名单。
     - `get_location_by_ip`：根据 IP 地址获取地理位置信息。

3. **server.py**
   - **功能**：实现服务端逻辑，处理客户端请求并返回响应。
   - **核心类**：
     - `TCPHandler`：继承自 `socketserver.BaseRequestHandler`，处理客户端连接和请求。
     - `ClientConnectionManager`：管理客户端连接，支持实时消息推送。
   - **路由系统**：
     - 使用字典 `ROUTER` 映射请求类型到对应的处理函数，支持用户管理、消息处理、白名单审核等功能。

### 核心算法
1. **用户注册与登录**
   - **注册流程**：
     1. 客户端发送注册请求，包含用户名、密码、邮箱等信息。
     2. 服务端验证信息完整性，检查用户名、邮箱和手机号是否已被注册。
     3. 对密码进行哈希加密后存储到数据库。
     4. 自动生成玩家 UUID 并初始化玩家数据。
   - **登录流程**：
     1. 客户端发送登录请求，包含用户名和密码。
     2. 服务端验证用户名和密码，返回用户信息及登录状态。

2. **即时通讯**
   - **消息发送与接收**：
     1. 发送方客户端通过 TCP 将消息发送到服务端。
     2. 服务端存储消息到数据库，并将消息转发给接收方。
     3. 接收方客户端实时接收服务端推送的消息。
   - **消息存储**：
     消息以结构化形式存储在数据库中，包含发送者 ID、接收者 ID、消息内容、时间戳等字段。

3. **白名单管理**
   - **申请流程**：
     1. 用户通过客户端提交白名单申请，包含玩家名、账号类型和申请理由。
     2. 服务端将申请记录存储到文件系统，等待管理员审核。
   - **审核流程**：
     1. 管理员通过管理面板查看待审核申请。
     2. 管理员批准或拒绝申请，服务端更新数据库中的白名单状态，并通过 RCON 命令同步到我的世界服务器。

4. **排行榜算法**
   - 基于用户拥有的金币和星星数量进行排名。
   - 每次请求排行榜时，服务端从数据库中查询并按数量降序排列，返回前 100 名用户数据。

以上设计和规范确保了代码的可读性、可维护性和扩展性，同时支持系统的功能需求和性能要求。