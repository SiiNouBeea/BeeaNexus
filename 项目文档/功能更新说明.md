# BeeaNexus 功能更新说明

## 新增功能概览

本次更新主要实现了以下功能：

### 1. 白名单管理增强
- **功能描述**：管理员审核白名单后，服务端自动读取路径"../Server/whitelist.json"并添加通过白名单玩家的名字
- **实现细节**：
  - 审核通过后，自动检查白名单文件是否存在
  - 如不存在则创建新的白名单文件
  - 检查玩家是否已在白名单中，避免重复添加
  - 为新玩家生成UUID并添加到白名单
  - 通过RCON命令将玩家添加到游戏服务器白名单
  - 发送服务器公告："玩家XXX通过白名单申请"

### 2. Minecraft服务器状态检测
- **功能描述**：使用mcrcon对mc游戏内服务器进行指令操作时，先判断服务器是否在线
- **实现细节**：
  - 新增`check_mc_server_online()`函数检测服务器状态
  - 所有RCON操作前都会检查服务器在线状态
  - 服务器离线时不执行任何RCON操作
  - 提供友好的错误提示信息

### 3. 服务器控制台
- **功能描述**：在管理员控制面板新增一页服务器控制台，可以输入我的世界的命令并获取返回值
- **实现细节**：
  - 新增`ServerConsolePage`类实现控制台界面
  - 提供命令输入框和执行按钮
  - 显示命令执行结果
  - 只有管理员权限的用户可以访问
  - 支持常用Minecraft命令的执行

### 4. 服务器状态监控
- **功能描述**：在客户端的首页，增加一块内容，可以自动获取服务器内在线人数以及在线玩家列表，通过一个刷新按钮进行刷新
- **实现细节**：
  - 主页新增服务器状态显示区域
  - 显示Minecraft服务器在线状态（在线/离线）
  - 显示当前在线人数
  - 显示在线玩家列表
  - 提供手动刷新按钮
  - 管理员用户每60秒自动刷新一次

### 5. 游戏内在线状态管理
- **功能描述**：
  - 新增一个游戏内在线标识以区分社区客户端在线和游戏内在线
  - 将原本的在线标记改为"社区在线"
  - 新增"游戏在线"标识
  - 服务端每60秒查询一次mc服务器是否在线，若服务器在线，则获取一次玩家列表
  - 通过玩家名查询对应的用户uid，在客户端中标记该玩家游戏在线
- **实现细节**：
  - 新增`GameOnlineManager`类管理游戏内在线状态
  - 实现60秒定时检查机制
  - 通过RCON命令`list`获取在线玩家列表
  - 解析玩家名并查询对应用户ID
  - 在客户端显示不同的在线状态标识
  - 社区在线：浅绿色背景
  - 游戏在线：浅红色背景

### 6. 玩家踢出功能
- **功能描述**：管理员可以在用户控制面板点击按钮直接将其踢出服务器
- **实现细节**：
  - 在服务器控制台页面显示在线玩家列表
  - 每个玩家行提供"踢出"按钮
  - 踢出前显示确认对话框
  - 通过RCON命令`kick`执行踢出操作
  - 踢出成功后自动刷新在线玩家列表

## 技术实现要点

### 服务端架构更新
1. **新增路由函数**：
   - `route_get_server_status`: 获取服务器状态
   - `route_execute_mc_command`: 执行Minecraft命令
   - `route_kick_player`: 踢出玩家
   - `route_get_game_online_users`: 获取游戏内在线用户
   - `route_refresh_game_online_status`: 刷新游戏内在线状态

2. **新增管理类**：
   - `GameOnlineManager`: 游戏内在线状态管理器
   - 使用线程实现60秒定时检查
   - 线程安全的在线用户集合管理

3. **数据库扩展**：
   - 新增`get_user_id_by_player_name`方法
   - 通过玩家名查询用户ID

### 客户端界面更新
1. **主页面增强**：
   - 新增服务器状态显示区域
   - 支持在线状态视觉区分
   - 排行榜显示在线状态标识

2. **新增控制台页面**：
   - 服务器状态监控
   - 命令执行界面
   - 在线玩家管理

### 安全考虑
1. **权限控制**：
   - 所有服务器管理功能仅限管理员使用
   - 操作前验证用户权限
   - 敏感操作需要确认

2. **错误处理**：
   - 完善的异常捕获机制
   - 友好的错误提示信息
   - 操作失败时的回滚机制

## 使用说明

### 管理员操作指南
1. **访问服务器控制台**：
   - 登录管理员账户
   - 在导航栏选择"服务器控制台"
   - 查看服务器状态和在线玩家

2. **执行Minecraft命令**：
   - 在命令输入框输入命令
   - 点击"执行命令"按钮
   - 查看命令执行结果

3. **管理在线玩家**：
   - 在在线玩家列表中查看所有游戏内在线用户
   - 点击"踢出"按钮将玩家踢出服务器
   - 确认操作后玩家将被踢出

4. **审核白名单申请**：
   - 在管理员面板查看待审核申请
   - 审核通过后自动处理白名单添加
   - 服务器公告会自动发送

### 普通用户功能
1. **查看服务器状态**：
   - 在主页查看服务器在线状态和人数
   - 查看在线玩家列表
   - 使用刷新按钮更新状态

2. **查看在线状态**：
   - 排行榜中显示不同颜色的在线标识
   - 绿色表示社区在线
   - 红色表示游戏内在线

## 系统要求

### 运行环境
- Python 3.8+
- PyQt5
- MySQL 8.0+
- Minecraft服务器（支持RCON）
- 网络连接（用于获取地理位置信息）

### 文件结构要求
```
服务端根目录/
├── ...
└── Server/
    └── whitelist.json  # Minecraft白名单文件
```

## 后续优化建议

1. **性能优化**：
   - 缓存服务器状态查询结果
   - 优化在线状态同步机制
   - 减少不必要的RCON调用

2. **功能扩展**：
   - 添加更多服务器管理命令
   - 支持批量操作
   - 添加服务器性能监控

3. **用户体验**：
   - 提供更丰富的视觉反馈
   - 添加操作日志记录
   - 支持命令历史记录

---

**更新时间**: 2025-12-07  
**版本**: v2.0  
**作者**: AI Assistant
